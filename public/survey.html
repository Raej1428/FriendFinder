<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Survey Page</title>

    <!-- Latest compiled and minified CSS & JS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

</head>

<body>

    <div class="container">

        <div class="jumbotron">
            <h1 class="text-center">
                <span class="fa fa-fire"></span> Friend Finder</h1>
            <hr>
            <h2 class="text-center">Fill out the Survey. Find a new friend.</h2>
            <br>
            <div class="text-center">
                <!-- <a href="/friends">
          <button class="btn btn-lg btn-primary">
            <span class="fa fa-list-alt"></span> View friends</button>
        </a> -->
                <a href="/">
                    <button class="btn btn-lg btn-default">
                        <span class="fa fa-home"></span>
                    </button>
                </a>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <!-- Survey Page -->
                <div class="card">
                    <div class="card-header">
                        Friend Survey
                        <p> Fill out your name and add a link to your photo. The survey questions will appear with one
                            word, rate how you feel about that word on a scale of 1(I hate it) to 5(I love it). You will
                            be matched based on this data so be honest!</p>
                    </div>
                    <div class="card-body">
                        <form role="form">
                            <div class="form-group">
                                <label for="survey-name">Name</label>
                                <input type="text" class="form-control" id="survey-name">
                            </div>
                            <div class="form-group">
                                <label for="survey-photo">Photo Link</label>
                                <input type="text" class="form-control" id="survey-photo">
                            </div>

                            <div class="form-group">
                                <label for="survey-lasagna">Lasagna</label>
                                <input type="text" class="form-control" id="survey-lasagna">
                            </div>
                            <div class="form-group">
                                <label for="survey-bologna">Bologna</label>
                                <input type="text" class="form-control" id="survey-bologna">
                            </div>
                            <div class="form-group">
                                <label for="survey-bluecheese">Blue Cheese</label>
                                <input type="text" class="form-control" id="survey-bluecheese">
                            </div>
                            <div class="form-group">
                                <label for="survey-recycling">Recycling</label>
                                <input type="text" class="form-control" id="survey-recycling">
                            </div>
                            <div class="form-group">
                                <label for="survey-dancing">Dancing</label>
                                <input type="text" class="form-control" id="survey-dancing">
                            </div>
                            <div class="form-group">
                                <label for="survey-computers">Computers</label>
                                <input type="text" class="form-control" id="survey-computers">
                            </div>
                            <div class="form-group">
                                <label for="survey-socialmedia">Social Media</label>
                                <input type="text" class="form-control" id="survey-socialmedia">
                            </div>
                            <div class="form-group">
                                <label for="survey-sports">Pro Sports</label>
                                <input type="text" class="form-control" id="survey-sports">
                            </div>
                            <div class="form-group">
                                <label for="survey-dogs">Dogs</label>
                                <input type="text" class="form-control" id="survey-dogs">
                            </div>
                            <div class="form-group">
                                <label for="survey-cats">Cats</label>
                                <input type="text" class="form-control" id="survey-cats">
                            </div>
                            <button type="submit" class="btn btn-primary submit">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Friends Match Modal -->
        <div id="resultsModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
    
              <!-- Modal Content-->
              <div class="modal-content">
    
                <!-- "X" Button to close the modal -->
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h2 class="modal-title"><strong>Meet Your New Friend!</strong></h2>
                </div>
    
                <!-- Modal Body (For Match Info) -->
                <div class="modal-body">
                  <h2 id="matchName"></h2>
                  <img id="matchImg" src="" alt="Image Not Found" style="max-width: 350px;">
                </div>
    
                <!-- Modal Footer (Close Button) -->
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
    
              </div>
    
            </div>
          </div>
    
    
        </div>
    </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>
                <a href="/api/friends">API friend Link</a>
        </div>
    </footer>

    </div>

</body>

</html>

<!-- BELOW CODE IS CRITICAL. IT HANDLES HOW FORM DATA IS SENT TO OUR SERVER -->
<script type="text/javascript">
    // Global Variable Declaration (scoping fix)
    var allFieldsCompleted;

    $(document).ready(function () {

        // Event Listener for Submission
        $('#submitButton').on('click', function () {

            // Check if all the user fields are completed
            checkIfComplete(function () {

                // Proceed with AJAX call if all questions are answered
                if (allFieldsCompleted) {
                    collectInputs();
                }
                else {
                    alert('Please complete all fields before submitting!');
                }

            }); // end checkIfComplete() callback

        }); // end submit listener

    }); // document ready


    // Function to valid user input
    function checkIfComplete(callback) {

        // Check through all the questions (i.e. iterate through all of class "form-control")
        var questionsCompleted;
        $('.form-control').each(function () {
            if ($(this).val() == "") {
                questionsCompleted = false;
            }
        })

            // This counters the async behavior of $.each()
            .promise().done(function () {

                // Check if any questions are incomplete
                if (questionsCompleted == false) {
                    allFieldsCompleted = false;
                }

                // Determine if Name is entered
                else if ($('#survey-name').val().trim() == "") {
                    allFieldsCompleted = false;
                }

                // Determine if Link is entered
                else if ($('#survey-photo').val().trim() == "") {
                    allFieldsCompleted = false;
                }

                // Otherwise, the all fields are completed
                else {
                    allFieldsCompleted = true;
                }

                // Fire Off Callback (to counter async behavior of $.each)
                callback();

            });
    }


    function collectInputs() {

        // Make new friend object
        var newFriend = {
            name: $('#survey-name').val().trim(),
            photo: $('#survey-photo').val().trim(),
            scores: []
        }; // end variable

        // Loop through Questions to get scores
        var scoresArray = [];
        $('.form-control').each(function () {
            scoresArray.push(parseInt($(this).val())); // Parse Input Value as integer
        }) //begin promise
            // This counters the async behavior of $.each()
            .promise().done(function () {

                // Push the array of scores to the new friend object
                newFriend.scores = scoresArray;

                // POST the newFriend to the friends.js file and get back the best match
                var currentURL = window.location.origin;
                $.post(currentURL + "/api/friends", newFriend, function (data) {

                    // Add Best Match 
                    $('#matchName').text(data.customerName);
                    $('#matchImg').attr('src', data.photoNumber);

                    $("#resultsModal").modal('toggle');

                }); // end post

            }); //end promise

    }
</script>